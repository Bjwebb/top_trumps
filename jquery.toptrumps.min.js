/**
 * jQuery TopTrumps
 *
 * @version 0.9.0
 * @author Christian Hanne <mail@christianhanne.de>
 * @author Sophie Sievert <mail@sophiesievert.de>
 */
(function(e){"use strict";e.fn.toptrumps=function(t){var n={prepareSettings:function(t){var r=e.extend(true,{difficulty:"normal",trick:"ignore",fields:[],cards:[],onInit:function(e,t){},onComplete:function(e,t){},renderCard:function(e,t,n){}},t);r.players=["user","cpu"];r.fields=n.prepareFields(r.fields);r.cards=n.prepareCards(r.cards,r.fields);r.trumps=n.prepareTrumps(r.cards,r.fields);r.stacks=n.prepareStacks(r.cards,r.players);r.points={user:0,cpu:0};r.beginner=0;if(r.difficulty==="hard"){r.beginner=1}r.requeued={cpu:[],user:[]};return r},shuffleCards:function(e){var t=e.length;if(t===0){return false}while(--t){var n=Math.floor(Math.random()*(t+1));var r=e[t];var i=e[n];e[t]=i;e[n]=r}return e},prepareFields:function(e){var t=[];for(var n=0;n<e.length;n++){if(typeof e[n].name==="undefined"||typeof e[n].comparison==="undefined"){continue}if(e[n].comparison!=="<"&&e[n].comparison!==">"){continue}t.push(e[n])}return t},prepareCards:function(e,t){var r=[];for(var i=0;i<e.length;i++){if(typeof e[i].name==="undefined"||typeof e[i].fields==="undefined"){continue}if(e[i].fields.length!==t.length){continue}r.push(e[i])}r=n.shuffleCards(r);return r},prepareTrumps:function(e,t){var n=[];for(var r=0;r<e.length;r++){for(var i=0;i<e[r].fields.length;i++){if(typeof n[i]==="undefined"){n[i]=e[r].fields[i]}else if(t[i].comparison===">"&&e[r].fields[i]>n[i]){n[i]=e[r].fields[i]}else if(t[i].comparison==="<"&&e[r].fields[i]<n[i]){n[i]=e[r].fields[i]}}}return n},prepareStacks:function(t,n){var r=[];for(var i=0;i<n.length;i++){r[n[i]]=[]}var s=0;e.each(t,function(e,t){r[n[s]].push(t);s++;if(s>=n.length){s=0}});return r},renderGame:function(t,r){t.addClass("tt-wrapper");for(var i=0;i<r.players.length;i++){n.renderCardDeck(t,r,r.players[i])}var s=e("<div/>").addClass("tt-overlay");e("<a/>").addClass("tt-start-button").html("Start Game").appendTo(s);s.appendTo(t);e("a.tt-start-button",t).click(function(e){n.startGame(t,t.topTrumps);e.preventDefault()});r.onInit(t,e.extend(true,{},r))},renderCardDeck:function(t,n,r){var i=e("<div/>").addClass("tt-side tt-"+r);e("<div/>").addClass("tt-card-wrapper").appendTo(i);e("<div/>").addClass("tt-points").html("0").appendTo(i);if(n.trick==="requeue"){e("<div/>").addClass("tt-side-requeued").appendTo(i)}i.appendTo(t)},renderCards:function(t,r){var i=t.activeCards;e(".tt-card",r).remove();n.renderCard(i.cpu,"cpu",t,r);n.renderCard(i.user,"user",t,r);if(r.topTrumpsTurn==="user"){e(".tt-card-field",r).click(function(){var t=e(this).attr("id");var i=t.split("-");n.compareCards(i[i.length-1],r.topTrumps,r);return false})}else{var s=n.selectField(r.topTrumps,r);e("#tt-card-field-cpu-"+s).addClass("active");setTimeout(function(){n.compareCards(s,r.topTrumps,r)},2e3)}},renderCard:function(t,r,i,s){var o=e("<div/>").addClass("tt-card");if(r===s.topTrumpsTurn||r==="user"){e("<div/>").addClass("tt-card-name").html(t.name).appendTo(o);var u=n.renderCardFields(t,i.fields,i.trumps,r);u.appendTo(o)}else{e("<div/>").addClass("tt-card-name").html("?").appendTo(o);o.addClass("deactivated")}i.renderCard(o,e.extend(true,{},t),e.extend(true,{},i.fields));o.appendTo(s.find(".tt-"+r+" .tt-card-wrapper"))},renderCardFields:function(t,n,r,i){var s=e("<div/>").addClass("tt-card-fields");for(var o=0;o<n.length;o++){var u=e("<div/>").attr("id","tt-card-field-"+i+"-"+o).addClass("tt-card-field");e("<span/>").addClass("tt-card-field-value").html(t.fields[o]).appendTo(u);if(typeof n[o].classes!=="undefined"){u.addClass(n[o].classes)}if(typeof n[o].prefix!=="undefined"){e("<span/>").addClass("tt-card-field-prefix").html(n[o].prefix).prependTo(u)}if(typeof n[o].suffix!=="undefined"){e("<span/>").addClass("tt-card-field-suffix").html(n[o].suffix).appendTo(u)}e("<span/>").addClass("tt-card-field-name").html(n[o].name).prependTo(u);if(t.fields[o]===r[o]){u.addClass("top-trump")}u.appendTo(s)}return s},startGame:function(t,r){t.topTrumpsTurn=r.players[r.beginner];e(".tt-overlay",t).remove();n.nextTurn(t,r)},nextTurn:function(e,t){t.activeCards={cpu:t.stacks.cpu.shift(),user:t.stacks.user.shift()};n.renderCards(t,e)},compareCards:function(e,t,r){var i=t.activeCards;var s="draw";switch(t.fields[e].comparison){case"<":if(i.cpu.fields[e]<i.user.fields[e]){s="cpu"}else{s="user"}break;case">":if(i.cpu.fields[e]>i.user.fields[e]){s="cpu"}else{s="user"}break}n.processResult(s,t,r)},selectField:function(e,t){var n=e.activeCards;switch(e.difficulty){case"easy":return Math.round(Math.random()*(e.fields.length-1));case"normal":case"hard":var r=[];for(var i=0;i<e.fields.length;i++){if(e.fields[i].comparison===">"){r[i]=1-(e.trumps[i]-n.cpu.fields[i])/e.trumps[i]}else{r[i]=1-(n.cpu.fields[i]-e.trumps[i])/n.cpu.fields[i]}}var s=0;var o=0;for(var i=0;i<r.length;i++){if(o<r[i]){s=i;o=r[i]}}return s}return 0},processResult:function(t,r,i){switch(t){case"cpu":case"user":if(i.topTrumpsTurn!==t){i.topTrumpsTurn=t}r.points[t]+=1;e(".tt-side.tt-"+t+" .tt-points",i).html(r.points[t]);break;case"draw":r.requeued.cpu.push(r.activeCards.cpu);r.requeued.user.push(r.activeCards.user);break}i.topTrumps=r;if(r.stacks.cpu.length>0&&r.stacks.user.length>0){n.nextTurn(i,i.topTrumps)}else{if(r.trick==="requeue"&&r.requeued.cpu.length>0&&r.requeued.user.length){r.stacks.cpu=n.shuffleCards(r.requeued.cpu);r.stacks.user=n.shuffleCards(r.requeued.user);i.topTrumps=r;n.nextTurn(i,i.topTrumps)}else{n.endGame(i,i.topTrumps)}}},endGame:function(t,n){e(".tt-card",t).remove();n.onComplete(t,e.extend(true,{},n))}},r=n.prepareSettings(t);return this.each(function(){var t=e(this);t.topTrumps=r;n.renderGame(t,r)})}})(jQuery)